<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line è²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹ - Meikoå¾®èª²é »é“</title>
    <link rel="icon" type="image/png" href="./favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            /* Slate 900 - Dark Mode */
            color: #f8fafc;
        }

        /* LINE Brand Colors */
        .text-line {
            color: #06C755;
        }

        .bg-line {
            background-color: #06C755;
        }

        .bg-line:hover {
            background-color: #05b34c;
        }

        .border-line {
            border-color: #06C755;
        }

        .ring-line {
            --tw-ring-color: #06C755;
        }

        /* Checkerboard pattern */
        .grid-bg {
            background-image: linear-gradient(45deg, #334155 25%, transparent 25%),
                linear-gradient(-45deg, #334155 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #334155 75%),
                linear-gradient(-45deg, transparent 75%, #334155 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
            background-color: #1e293b;
        }

        .step-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-radio:checked+div {
            border-color: #06C755;
            background-color: rgba(6, 199, 85, 0.1);
            color: #06C755;
            font-weight: 700;
        }

        input[type="range"] {
            accent-color: #06C755;
        }

        .btn-press:active {
            transform: scale(0.98);
        }

        .collapse-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .collapse-open {
            max-height: 1500px;
            opacity: 1;
        }

        .prompt-content h2 {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 0.5em;
            color: #e2e8f0;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.2em;
            margin-top: 1em;
        }

        .prompt-content h2:first-child {
            margin-top: 0;
        }

        .prompt-content p {
            margin-bottom: 0.5em;
            line-height: 1.6;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .prompt-content ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.5em;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .var-highlight {
            color: #f87171;
            font-weight: bold;
            background-color: rgba(254, 242, 242, 0.1);
            padding: 0 4px;
            border-radius: 4px;
        }

        .fixed-val {
            font-weight: bold;
            color: #38bdf8;
        }

        .no-highlight {
            color: inherit;
            font-weight: normal;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons ---
        const Icon = ({ children, className, spin, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className || ''} ${spin ? 'animate-spin' : ''}`} {...props}>{children}</svg>
        );
        const IconUpload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></Icon>;
        const IconScissors = (props) => <Icon {...props}><circle cx="6" cy="6" r="3" /><path d="M8.12 8.12 12 12" /><path d="M20 4 8.12 15.88" /><circle cx="6" cy="18" r="3" /><path d="M14.8 14.8 20 20" /></Icon>;
        const IconDownload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></Icon>;
        const IconLoader = (props) => <Icon {...props} spin><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const IconEraser = (props) => <Icon {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></Icon>;
        const IconCheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></Icon>;
        const IconMessageCircle = (props) => <Icon {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" /></Icon>;
        const IconHash = (props) => <Icon {...props}><line x1="4" x2="20" y1="9" y2="9" /><line x1="4" x2="20" y1="15" y2="15" /><line x1="10" x2="8" y1="3" y2="21" /><line x1="16" x2="14" y1="3" y2="21" /></Icon>;
        const IconMoon = (props) => <Icon {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></Icon>;
        const IconSettings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
        const IconChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6" /></Icon>;
        const IconCopy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></Icon>;
        const IconWand2 = (props) => <Icon {...props}><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z" /><path d="m14 7 3 3" /><path d="M5 6v4" /><path d="M19 14v4" /><path d="M10 2v2" /><path d="M7 8H3" /><path d="M21 16h-4" /><path d="M11 3H9" /></Icon>;
        const IconStar = (props) => <Icon {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></Icon>;
        const IconTag = (props) => <Icon {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" /><path d="M7 7h.01" /></Icon>;
        const IconCrop = (props) => <Icon {...props}><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15" /><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15" /></Icon>;
        const IconInfo = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></Icon>;

        const logoSrc = "https://rain-galley-248.notion.site/image/attachment%3A1a4404e1-e6b1-4f29-a495-123224c6135a%3AMeiko_logo.png?table=block&id=2c04c228-35e5-80d2-b534-f270fb01613d&spaceId=cf48a189-fd68-4fe6-a35c-bf6538001b35&width=770&userId=&cache=v2";

        const PROMPT_THEMES = {
            daily: { label: 'æ—¥å¸¸ç”¨èª', texts: 'æ—©å®‰ã€æ™šå®‰ã€è¬è¬ã€ä¸å®¢æ°£ã€å°ä¸èµ·ã€æ²’å•é¡Œã€å¥½çš„ã€æ”¶åˆ°ã€æ‹œè¨—ã€è¾›è‹¦äº†ã€OKã€ç­‰ç­‰', emotions: 'å–œã€æ€’ã€å“€ã€æ¨‚ã€é©šè¨ã€ç„¡èªã€æ”¾ç©ºã€å¤§å“­', actions: 'è¬è¬é…é›™æ‰‹åˆåã€OKæ¯”æ‰‹å‹¢ã€æ—©å®‰æ®æ‰‹ã€ç™¼å‘†æµå£æ°´' },
            greet: { label: 'æ‰“æ‹›å‘¼', texts: 'Helloã€Hiã€æ—©å®‰ã€åˆå®‰ã€æ™šå®‰ã€ä½ å¥½ã€åƒé£½æ²’ã€å¥½ä¹…ä¸è¦‹ã€åˆæ¬¡è¦‹é¢ã€æ­¡è¿ã€æœ‰ç©ºå—ã€æ°æ°', emotions: 'ç†±æƒ…ã€å¾®ç¬‘ã€çœ¨çœ¼ã€æœŸå¾…ã€å®³ç¾ã€å‹å–„', actions: 'æ®æ‰‹è‡´æ„ã€90åº¦é èº¬ã€å¾è§’è½æ¢é ­ã€æ¯”æ‰‹æŒ‡æ„›å¿ƒã€æ‹¿è‘—å¤§è²å…¬' },
            holiday: { label: 'ç¯€æ—¥ç¥ç¦', texts: 'æ–°å¹´å¿«æ¨‚ã€æ­å–œç™¼è²¡ã€ç”Ÿæ—¥å¿«æ¨‚ã€è–èª•å¿«æ¨‚ã€æƒ…äººç¯€å¿«æ¨‚ã€ä¸­ç§‹å¿«æ¨‚ã€æ¯è¦ªç¯€å¿«æ¨‚ã€çˆ¶è¦ªç¯€å¿«æ¨‚ã€ç«¯åˆå®‰åº·ã€è¬è–ç¯€å¿«æ¨‚ã€Happy New Yearã€ç´…åŒ…æ‹¿ä¾†', emotions: 'å–œæ°£æ´‹æ´‹ã€èˆˆå¥®ã€æº«é¦¨ã€å¤§ç¬‘ã€æ„Ÿå‹•ã€æ´¾å°è‡‰', actions: 'é›™æ‰‹æ‹¿ç´…åŒ…ã€é»ç‡ƒé­ç‚®ã€æ§è‘—ç”Ÿæ—¥è›‹ç³•ã€é€å‡ºç¦®ç‰©ç›’ã€èˆ‰æ¯æ…¶ç¥' },
            response: { label: 'å›æ‡‰ç¯‡', texts: 'çœŸçš„å‡çš„ã€ç¬‘æ­»ã€ç¢º?ã€å¥½å–”ã€??ã€!!!ã€ç„¡è¨€ã€å‚»çœ¼ã€å²å®³ã€ä½©æœã€+1ã€è·¯é', emotions: 'éœ‡é©šåˆ°è®Šå½¢ã€ç¿»ç™½çœ¼ã€æ‡·ç–‘çœ¼ç¥ã€è±èµ·å¤§æ‹‡æŒ‡ã€æ•·è¡å‡ç¬‘', actions: 'æ¯”è®šã€é›™æ‰‹æ‰“å‰(NG)ã€å–®æ‰‹æ‰¶é¡é ­ã€åƒç“œçœ‹æˆ²ã€æ¯”å‡º OK æ‰‹å‹¢' },
            work: { label: 'ä¸Šç­æ—', texts: 'æ”¶åˆ°ã€é¦¬ä¸Šæ”¹ã€é–‹æœƒä¸­ã€åŠ ç­ã€æº–æ™‚ä¸‹ç­ã€å¿ƒç´¯ã€å ±å‘Šé•·å®˜ã€è¾›è‹¦äº†ã€æ±‚æ”¾éã€è–ªæ°´å‘¢ã€ä¸æƒ³ä¸Šç­ã€åŠ æ²¹', emotions: 'çœ¼ç¥æ­»ã€å´©æ½°å¤§å“­ã€è·æ¥­å‡ç¬‘ã€é»‘çœ¼åœˆæ·±é‡ã€ç‡ƒç‡’é¬¥å¿—', actions: 'ç˜‹ç‹‚æ•²éµç›¤ã€åŠé»æ»´å–å’–å•¡ã€è¶´åœ¨æ¡Œä¸Šéˆé­‚å‡ºç«…ã€æ¨™æº–æ•¬ç¦®ã€èˆ‰ç™½æ——æŠ•é™' },
            couple: { label: 'è€å…¬è€å©†', texts: 'æ„›ä½ ã€æƒ³ä½ ã€æŠ±æŠ±ã€è¦ªè¦ªã€å¯¶è²ã€è€å…¬ã€è€å©†ã€åœ¨å¹¹å˜›ã€å¿«å›å®¶ã€è²·çµ¦æˆ‘ã€åŸè«’æˆ‘ã€å•¾å’ª', emotions: 'å®³ç¾è‡‰ç´…ã€è‰²ç‡ç‡ã€æ’’å¬Œæ°´æ±ªæ±ªå¤§çœ¼ã€ç”Ÿæ°£é¼“è‡‰ã€é™¶é†‰', actions: 'æŠ±ç·Šè™•ç†ã€ç™¼å°„é£›å»ã€è·ªç®—ç›¤è¬ç½ªã€æ‘¸é ­æ®ºã€å£å’š' },
            meme: { label: 'è¿·å› æç¬‘', texts: 'æ˜¯åœ¨å“ˆå›‰ã€æˆ‘å°±çˆ›ã€é˜¿å§¨æˆ‘ä¸æƒ³åŠªåŠ›äº†ã€åƒæ¥µäº†æ„›æƒ…ã€å¯æ†å“ªã€åš‡åˆ°åƒæ‰‹æ‰‹ã€æ²’åœ¨æ€•ã€æœ¬æ–¥ä½†å¤§ã€çœŸé¦™ã€æ­¸å‰›æ¬¸ã€çªç ´ç›²è…¸ã€æ€•', emotions: 'æ¥µåº¦å˜²è«·è‡‰ã€å …å®šçœ¼ç¥ã€çŒ¥ç‘£ç¬‘å®¹ã€å´©å£é¡è—ã€é„™è¦–çœ¼ç¥', actions: 'æ”¤æ‰‹ç„¡å¥ˆã€æŒ‡æŒ‡é»é»ã€æˆ´å¢¨é¡è€å¸¥ã€æ‹¿è‘—é¹¹é­šæ”»æ“Šã€è¬ä¹‹èˆæ­¥' }
        };

        const PROMPT_STYLES = {
            qversion: { label: 'é€šç”¨ Q ç‰ˆ', desc: 'å¯æ„›ã€æ´»æ½‘ã€2Då¹³é¢' },
            realistic: { label: 'å¯«å¯¦é¢¨æ ¼', desc: 'ç´°ç·»ã€æ“¬çœŸã€é«˜è³ªæ„Ÿ' },
            threed: { label: '3D ç«‹é«”', desc: 'Blenderé¢¨æ ¼ã€åœ“æ½¤ã€å…‰å½±' },
            sketch: { label: 'æ‰‹ç¹ªå¡—é´‰', desc: 'ç·šæ¢æ„Ÿã€ç«¥è¶£ã€è Ÿç­†' },
            pixel: { label: 'åƒç´ é¢¨', desc: 'å¾©å¤éŠæˆ²ã€8-bit' },
            anime: { label: 'æ—¥ç³»å‹•æ¼«', desc: 'å¤§çœ¼ã€è³½ç’ç’ä¸Šè‰²' }
        };

        const App = () => {
            const [originalSheet, setOriginalSheet] = useState(null);
            const [slicedPieces, setSlicedPieces] = useState([]);
            const [finalImages, setFinalImages] = useState([]);
            const [mainId, setMainId] = useState(null);
            const [tabId, setTabId] = useState(null);
            const [startNumber, setStartNumber] = useState(1);
            const [step, setStep] = useState(1);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processedCount, setProcessedCount] = useState(0);
            const [showSettings, setShowSettings] = useState(false);
            const [showAdvanced, setShowAdvanced] = useState(true);
            const [showPromptGuide, setShowPromptGuide] = useState(true);
            const [copySuccess, setCopySuccess] = useState(false);
            const [activeTheme, setActiveTheme] = useState('daily');
            const [activeStyle, setActiveStyle] = useState('qversion');
            const [autoRemoveBg, setAutoRemoveBg] = useState(true);
            const [targetColorHex, setTargetColorHex] = useState("#00ff00");
            const [colorTolerance, setColorTolerance] = useState(30);
            const [smoothness, setSmoothness] = useState(2);
            const [despill, setDespill] = useState(true);
            const [zoomLevel, setZoomLevel] = useState(1.00);
            const workerRef = useRef(null);

            useEffect(() => {
                workerRef.current = new Worker('./worker.js');
                workerRef.current.onmessage = (e) => {
                    const { id, processedImageData } = e.data;

                    // Convert ImageData back to DataURL
                    const canvas = document.createElement('canvas');
                    canvas.width = processedImageData.width;
                    canvas.height = processedImageData.height;
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(processedImageData, 0, 0);

                    const dataUrl = canvas.toDataURL('image/png');

                    setFinalImages(prev => {
                        const exists = prev.find(img => img.id === id);
                        if (exists) return prev;
                        return [...prev, { id, dataUrl, rawSource: null }].sort((a, b) => a.id - b.id);
                    });
                    setProcessedCount(prev => prev + 1);
                };
                return () => { workerRef.current.terminate(); }
            }, []);

            useEffect(() => {
                if (processedCount === 12 && isProcessing) {
                    setIsProcessing(false);
                    setMainId(1);
                    setTabId(1);
                    setStep(3);
                }
            }, [processedCount, isProcessing]);

            useEffect(() => {
                applyPreset('green');
            }, []);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        setOriginalSheet(img);
                        setSlicedPieces([]);
                        setFinalImages([]);
                        setStep(1);
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const getPromptText = () => {
                const theme = PROMPT_THEMES[activeTheme];
                const style = PROMPT_STYLES[activeStyle];
                return `âœ… 12 æ ¼è§’è‰²è²¼åœ–é›†ï½œPrompt å»ºè­°\nè«‹åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ï¼Œç”Ÿæˆ ä¸€å¼µåŒ…å« 12 å€‹ä¸åŒå‹•ä½œçš„è§’è‰²è²¼åœ–é›†ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ä»»ä½•emojiè¡¨æƒ…ç¬¦è™Ÿã€‚\n\n[è§’è‰²èˆ‡é¢¨æ ¼è¨­å®š]\nè§’è‰²ä¸€è‡´æ€§ï¼šå¿…é ˆå®Œå…¨ç¶­æŒåŸåœ–ä¸»è§’çš„é«®å‹ã€æœè£ã€äº”å®˜èˆ‡æ•´é«”å¤–è§€ç‰¹å¾µã€‚\næ§‹åœ–é¢¨æ ¼ï¼šç•«é¢åƒ…åŒ…å«ã€Œè§’è‰² + æ–‡å­—ã€ï¼Œä¸åŒ…å«ä»»ä½•å ´æ™¯èƒŒæ™¯ã€‚\nç•«é¢¨è¨­å®šï¼šã€${style.desc}ã€‘ã€‚\nè²¼ç´™é¢¨æ ¼ï¼ˆå»èƒŒå‹å–„ï¼‰ï¼šè§’è‰²èˆ‡æ–‡å­—å¤–åœçš†éœ€åŠ å…¥ ç²—ç™½è‰²å¤–æ¡†ï¼ˆSticker Styleï¼‰ã€‚èƒŒæ™¯çµ±ä¸€ç‚º #00FF00ï¼ˆç´”ç¶ è‰²ï¼‰ï¼Œä¸å¯æœ‰é›œé»ã€‚\n\n[ç•«é¢ä½ˆå±€èˆ‡å°ºå¯¸è¦æ ¼]\næ•´é«”ç‚º 4 Ã— 3 ä½ˆå±€ï¼Œå…± 12 å¼µè²¼åœ–ã€‚ç¸½å°ºå¯¸ï¼š1480 Ã— 960 pxã€‚\næ¯å¼µå°åœ–ç´„ 370 Ã— 320 pxï¼ˆè‡ªå‹•ç­‰æ¯”ç¸®æ”¾å¡«æ»¿æ’åˆ—ï¼‰ã€‚æ¯å¼µè²¼åœ–å››å‘¨é ç•™ç´„ 0.2 cm Paddingï¼Œé¿å…ç•«é¢äº’ç›¸é»ä½ã€‚\né¡é ­å¤šæ¨£åŒ–ï¼šå…¨èº« + åŠèº«æ··åˆï¼Œå¿…é ˆåŒ…å«æ­£é¢ã€å´é¢ã€ä¿¯è§’ç­‰ä¸åŒè¦–è§’ã€‚\n\n[æ–‡å­—è¨­è¨ˆ]\nèªè¨€ï¼šã€å°ç£ç¹é«”ä¸­æ–‡ã€‘\næ–‡å­—å…§å®¹ï¼šã€${theme.texts}ã€‘\nå­—å‹é¢¨æ ¼ï¼šã€å¯æ„› Q ç‰ˆå­—å‹ï¼Œé¡è‰²é®®è±”ã€æ˜“è®€ï¼Œå¤šè‰²å½©æ··åˆï¼Œçµ•å°ç¦æ­¢ä½¿ç”¨ä»»ä½•ç¶ è‰²ï¼ˆåŒ…å«æ·±ç¶ ã€æ·ºç¶ ã€è¢å…‰ç¶ ã€è—ç¶ ï¼‰èˆ‡é»‘è‰²ï¼Œå› ç‚ºæœƒå°è‡´å»èƒŒéŒ¯èª¤ã€‚è«‹æ”¹ç”¨ç´…ã€è—ã€ç´«ã€æ©˜ã€é»ƒç­‰é«˜å°æ¯”è‰²å½©ã€‚ã€‘\næ’ç‰ˆï¼šæ–‡å­—å¤§å°ç´„ä½”å–®å¼µè²¼åœ– 1/3ï¼Œæ–‡å­—å¯é©åº¦å£“åœ¨è¡£æœé‚Šè§’ç­‰éé‡è¦å€åŸŸï¼Œä¸èƒ½é®è‡‰,ä¹Ÿä¸è¦ä½¿ç”¨ä»»ä½•emojiè¡¨æƒ…ç¬¦è™Ÿã€‚\n\n[è¡¨æƒ…èˆ‡å‹•ä½œè¨­è¨ˆ]\nè¡¨æƒ…å¿…é ˆæ˜é¡¯ã€èª‡å¼µã€æƒ…ç·’è±å¯Œï¼šã€${theme.emotions}ã€‘\nè§’è‰²å‹•ä½œéœ€èˆ‡æ–‡å­—æƒ…å¢ƒä¸€è‡´ï¼šä¾‹å¦‚ã€${theme.actions}ã€‘\n12 æ ¼çš†é ˆç‚º ä¸åŒå‹•ä½œèˆ‡ä¸åŒè¡¨æƒ…ã€‚\n\n[è¼¸å‡ºæ ¼å¼]\nä¸€å¼µå¤§åœ–ï¼Œå…§å« 4 Ã— 3 çš„ 12 å¼µè²¼åœ–ã€‚èƒŒæ™¯å¿…é ˆç‚º ç´”ç¶ è‰² #00FF00ã€‚æ¯æ ¼è§’è‰² + æ–‡å­—å‡é™„ä¸Šç²—ç™½é‚Šã€‚`;
            };

            const handleCopyPrompt = () => {
                navigator.clipboard.writeText(getPromptText()).then(() => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                });
            };

            const performSlice = () => {
                if (!originalSheet) return;
                setIsProcessing(true);
                setTimeout(() => {
                    const pieces = [];
                    const cols = 4;
                    const rows = 3;
                    const pieceW = originalSheet.width / cols;
                    const pieceH = originalSheet.height / rows;
                    const canvas = document.createElement('canvas');
                    canvas.width = originalSheet.width;
                    canvas.height = originalSheet.height;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.drawImage(originalSheet, 0, 0);
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const pCanvas = document.createElement('canvas');
                            pCanvas.width = pieceW;
                            pCanvas.height = pieceH;
                            const pCtx = pCanvas.getContext('2d');
                            pCtx.drawImage(canvas, c * pieceW, r * pieceH, pieceW, pieceH, 0, 0, pieceW, pieceH);
                            pieces.push({
                                id: r * cols + c + 1,
                                rawCanvas: pCanvas,
                                previewUrl: pCanvas.toDataURL('image/png')
                            });
                        }
                    }
                    setSlicedPieces(pieces);
                    setStep(2);
                    setIsProcessing(false);
                }, 50);
            };

            const performProcessing = async () => {
                if (!autoRemoveBg) {
                    setFinalImages(slicedPieces.map(piece => ({ id: piece.id, dataUrl: piece.previewUrl })));
                    setMainId(1);
                    setTabId(1);
                    setStep(3);
                    return;
                }
                setIsProcessing(true);
                setProcessedCount(0);
                setFinalImages([]);
                const targetW = 370;
                const targetH = 320;
                const workW = targetW * 2;
                const workH = targetH * 2;
                slicedPieces.forEach(piece => {
                    const workCanvas = document.createElement('canvas');
                    workCanvas.width = workW;
                    workCanvas.height = workH;
                    const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });
                    const rawW = piece.rawCanvas.width;
                    const rawH = piece.rawCanvas.height;
                    const baseScale = Math.min(workW / rawW, workH / rawH);
                    const finalScale = baseScale * zoomLevel;
                    const drawW = rawW * finalScale;
                    const drawH = rawH * finalScale;
                    const dx = (workW - drawW) / 2;
                    const dy = (workH - drawH) / 2;
                    workCtx.drawImage(piece.rawCanvas, 0, 0, rawW, rawH, dx, dy, drawW, drawH);

                    const imgData = workCtx.getImageData(0, 0, workW, workH);

                    workerRef.current.postMessage({
                        id: piece.id,
                        rawImageData: imgData,
                        removalMode: targetColorHex === '#00FF00' ? 'flood' : 'feather', // Green screen uses flood (magic wand), black uses feather
                        targetColorHex: targetColorHex,
                        colorTolerance: colorTolerance,
                        erodeStrength: 0, // Default for now
                        smoothness: smoothness,
                        width: workW,
                        height: workH
                    });
                });
            };

            const resizeImageFromUrl = (dataUrl, width, height) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        const scale = Math.min(width / img.width, height / img.height);
                        const newW = img.width * scale;
                        const newH = img.height * scale;
                        ctx.drawImage(img, 0, 0, img.width, img.height, (width - newW) / 2, (height - newH) / 2, newW, newH);
                        resolve(canvas.toDataURL('image/png').split(',')[1]);
                    };
                    img.src = dataUrl;
                });
            };

            const getFileName = (index) => (startNumber + index).toString().padStart(2, '0');

            const downloadZip = async () => {
                const zip = new JSZip();
                await Promise.all(finalImages.map(async (img, idx) => {
                    const b64 = await resizeImageFromUrl(img.dataUrl, 370, 320);
                    zip.file(`${getFileName(idx)}.png`, b64, { base64: true });
                }));
                if (mainId) {
                    const mainImg = finalImages.find(img => img.id === mainId);
                    if (mainImg) zip.file("main.png", await resizeImageFromUrl(mainImg.dataUrl, 240, 240), { base64: true });
                }
                if (tabId) {
                    const tabImg = finalImages.find(img => img.id === tabId);
                    if (tabImg) zip.file("tab.png", await resizeImageFromUrl(tabImg.dataUrl, 96, 74), { base64: true });
                }
                zip.generateAsync({ type: "blob" }).then(c => saveAs(c, "line_stickers_pack.zip"));
            };

            const applyPreset = (type) => {
                if (type === 'green') {
                    setTargetColorHex("#00FF00");
                    setColorTolerance(30);
                    setSmoothness(2);
                    setDespill(true);
                    setZoomLevel(1.00);
                } else if (type === 'black') {
                    setTargetColorHex("#000000");
                    setColorTolerance(15);
                    setSmoothness(1);
                    setDespill(false);
                    setZoomLevel(1.00);
                }
            };

            const PromptDisplay = () => {
                const theme = PROMPT_THEMES[activeTheme];
                const style = PROMPT_STYLES[activeStyle];
                return (
                    <div className="prompt-content text-sm font-mono bg-slate-800 p-4 rounded-lg border border-slate-700 h-[380px] overflow-y-auto">
                        <div className="font-bold text-xl mb-2 text-white">âœ… 12 æ ¼è§’è‰²è²¼åœ–é›†ï½œPrompt å»ºè­°</div>
                        <p>è«‹åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ï¼Œç”Ÿæˆ ä¸€å¼µåŒ…å« 12 å€‹ä¸åŒå‹•ä½œçš„è§’è‰²è²¼åœ–é›†ã€‚</p>
                        <h2>[è§’è‰²èˆ‡é¢¨æ ¼è¨­å®š]</h2>
                        <ul>
                            <li>è§’è‰²ä¸€è‡´æ€§ï¼šå¿…é ˆå®Œå…¨ç¶­æŒåŸåœ–ä¸»è§’çš„é«®å‹ã€æœè£ã€äº”å®˜èˆ‡æ•´é«”å¤–è§€ç‰¹å¾µã€‚</li>
                            <li>æ§‹åœ–é¢¨æ ¼ï¼šç•«é¢åƒ…åŒ…å«ã€Œè§’è‰² + æ–‡å­—ã€ï¼Œä¸åŒ…å«ä»»ä½•å ´æ™¯èƒŒæ™¯ã€‚</li>
                            <li>ç•«é¢¨è¨­å®šï¼š<span className="var-highlight">ã€{style.desc}ã€‘</span>ã€‚</li>
                            <li>è²¼ç´™é¢¨æ ¼ï¼ˆå»èƒŒå‹å–„ï¼‰ï¼šè§’è‰²èˆ‡æ–‡å­—å¤–åœçš†éœ€åŠ å…¥ ç²—ç™½è‰²å¤–æ¡†ï¼ˆSticker Styleï¼‰ã€‚èƒŒæ™¯çµ±ä¸€ç‚º <span className="fixed-val">#00FF00ï¼ˆç´”ç¶ è‰²ï¼‰</span>ï¼Œä¸å¯æœ‰é›œé»ã€‚</li>
                        </ul>
                        <h2>[ç•«é¢ä½ˆå±€èˆ‡å°ºå¯¸è¦æ ¼]</h2>
                        <ul>
                            <li>æ•´é«”ç‚º 4 Ã— 3 ä½ˆå±€ï¼Œå…± 12 å¼µè²¼åœ–ã€‚ç¸½å°ºå¯¸ï¼š<span className="fixed-val">1480 Ã— 960 px</span>ã€‚</li>
                            <li>æ¯å¼µå°åœ–ç´„ 370 Ã— 320 pxï¼ˆè‡ªå‹•ç­‰æ¯”ç¸®æ”¾å¡«æ»¿æ’åˆ—ï¼‰ã€‚æ¯å¼µè²¼åœ–å››å‘¨é ç•™ç´„ 0.2 cm Paddingï¼Œé¿å…ç•«é¢äº’ç›¸é»ä½ã€‚</li>
                            <li>é¡é ­å¤šæ¨£åŒ–ï¼šå…¨èº« + åŠèº«æ··åˆï¼Œå¿…é ˆåŒ…å«æ­£é¢ã€å´é¢ã€ä¿¯è§’ç­‰ä¸åŒè¦–è§’ã€‚</li>
                        </ul>
                        <h2>[æ–‡å­—è¨­è¨ˆ]</h2>
                        <ul>
                            <li>èªè¨€ï¼š<span className="var-highlight">ã€å°ç£ç¹é«”ä¸­æ–‡ã€‘</span></li>
                            <li>æ–‡å­—å…§å®¹ï¼š<span className="var-highlight">ã€{theme.texts}ã€‘</span></li>
                            <li>å­—å‹é¢¨æ ¼ï¼š<span className="no-highlight">ã€å¯æ„› Q ç‰ˆå­—å‹ï¼Œé¡è‰²é®®è±”ã€æ˜“è®€ï¼Œå¤šè‰²å½©æ··åˆï¼Œçµ•å°ç¦æ­¢ä½¿ç”¨ä»»ä½•ç¶ è‰²ï¼ˆåŒ…å«æ·±ç¶ ã€æ·ºç¶ ã€è¢å…‰ç¶ ã€è—ç¶ ï¼‰èˆ‡é»‘è‰²ï¼Œå› ç‚ºæœƒå°è‡´å»èƒŒéŒ¯èª¤ã€‚è«‹æ”¹ç”¨ç´…ã€è—ã€ç´«ã€æ©˜ã€é»ƒç­‰é«˜å°æ¯”è‰²å½©ã€‚ã€‘</span></li>
                            <li>æ’ç‰ˆï¼šæ–‡å­—å¤§å°ç´„ä½”å–®å¼µè²¼åœ– 1/3ï¼Œæ–‡å­—å¯é©åº¦å£“åœ¨è¡£æœé‚Šè§’ç­‰éé‡è¦å€åŸŸï¼Œä¸èƒ½é®è‡‰ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ä»»ä½•emojiè¡¨æƒ…ç¬¦è™Ÿã€‚</li>
                        </ul>
                        <h2>[è¡¨æƒ…èˆ‡å‹•ä½œè¨­è¨ˆ]</h2>
                        <ul>
                            <li>è¡¨æƒ…å¿…é ˆæ˜é¡¯ã€èª‡å¼µã€æƒ…ç·’è±å¯Œï¼š<span className="var-highlight">ã€{theme.emotions}ã€‘</span></li>
                            <li>è§’è‰²å‹•ä½œéœ€èˆ‡æ–‡å­—æƒ…å¢ƒä¸€è‡´ï¼šä¾‹å¦‚<span className="var-highlight">ã€{theme.actions}ã€‘</span></li>
                            <li>12 æ ¼çš†é ˆç‚º ä¸åŒå‹•ä½œèˆ‡ä¸åŒè¡¨æƒ…ã€‚</li>
                        </ul>
                        <h2>[è¼¸å‡ºæ ¼å¼]</h2>
                        <ul>
                            <li>ä¸€å¼µå¤§åœ–ï¼Œå…§å« 4 Ã— 3 çš„ 12 å¼µè²¼åœ–ã€‚èƒŒæ™¯å¿…é ˆç‚º <span className="fixed-val">ç´”ç¶ è‰² #00FF00</span>ã€‚æ¯æ ¼è§’è‰² + æ–‡å­—å‡é™„ä¸Šç²—ç™½é‚Šã€‚</li>
                        </ul>
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-6 max-w-7xl mx-auto pb-32">
                    <header className="mb-8 bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div className="flex flex-col items-center md:items-start">
                            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                <IconMessageCircle className="w-8 h-8 text-line" />
                                Line è²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹
                            </h1>

                        </div>
                        <div className="flex items-center bg-slate-900 rounded-full px-6 py-2 border border-slate-700">
                            {[{ num: 1, label: 'ä¸Šå‚³èˆ‡åˆ†å‰²' }, { num: 2, label: 'å»èƒŒ' }, { num: 3, label: 'æ‰“åŒ…' }].map((s, idx) => (
                                <div key={s.num} className="flex items-center">
                                    <div className={`flex items-center gap-2 ${step >= s.num ? 'text-white' : 'text-slate-500'}`}>
                                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-colors ${step >= s.num ? 'bg-line text-white' : 'bg-slate-700 text-slate-500'}`}>{step > s.num ? <IconCheckCircle className="w-4 h-4" /> : s.num}</div>
                                        <span className={`text-sm font-medium ${step >= s.num ? 'text-white' : ''}`}>{s.label}</span>
                                    </div>
                                    {idx < 2 && <div className={`w-8 h-[2px] mx-3 rounded-full ${step > s.num ? 'bg-green-600' : 'bg-slate-700'}`}></div>}
                                </div>
                            ))}
                        </div>
                    </header>

                    <div className={`transition-opacity duration-500 ${step !== 1 ? 'opacity-0 hidden' : 'opacity-100'}`}>
                        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                            <div className="lg:col-span-3 bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-10 text-center">
                                <h2 className="text-2xl font-bold text-white mb-4">ä¸Šå‚³æ‚¨çš„è²¼åœ–åŸå§‹æª”</h2>
                                <div className="text-slate-400 mb-8 text-sm leading-relaxed max-w-3xl mx-auto bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                    <p className="mb-2 font-medium text-white">è«‹ä¸Šå‚³ AI ç”Ÿæˆçš„ 4x3 ç¶²æ ¼åœ– (JPG/PNG)ï¼Œåœ–ç‰‡éœ€è¦ç¬¦åˆä»¥ä¸‹è¦æ ¼ï¼š</p>
                                    <ul className="text-left list-none space-y-1 mb-4 pl-4 md:pl-12">
                                        <li>(1) æ•´é«”ç‚º 4æ¬„ Ã— 3åˆ— ä½ˆå±€ï¼Œå…± 12 å¼µè²¼åœ–ï¼Œç¸½å°ºå¯¸ï¼š<span className="text-sky-400 font-mono">2560 Ã— 1664 px</span>ã€‚</li>
                                        <li>(2) å»ºè­°ä½¿ç”¨ä¸‹æ–¹è¦ç¯„å¥½çš„Prompté€²è¡Œç”Ÿåœ–ï¼Œè‹¥ç™¼ç¾åœ–ç‰‡ç”Ÿæˆä¸ç¬¦åˆå°ºå¯¸ï¼Œå¯ä»¥å†æ¬¡è·ŸAIæå‡ºéœ€æ±‚ï¼Œè«‹AIä¾æ“šæŒ‡å®šçš„åƒç´ ä¿®æ”¹ã€‚</li>
                                    </ul>
                                    <p className="text-yellow-400 font-bold border-t border-slate-700 pt-3 mt-2">
                                        ğŸ’¡ å¯ä»¥åƒè€ƒä¸‹æ–¹ç”Ÿåœ–ã€AI æç¤ºè©å¤§å¸«ã€‘å…ˆç”Ÿæˆåœ–ç‰‡ï¼Œå†ä½¿ç”¨ã€Line è²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹ã€‘é€²è¡ŒåŠ å·¥ã€‚
                                    </p>
                                </div>

                                <div className="relative group w-full max-w-2xl mx-auto">
                                    <div className="border-2 border-dashed border-slate-600 rounded-2xl h-64 flex flex-col items-center justify-center bg-slate-900 group-hover:border-line group-hover:bg-slate-800 transition-all cursor-pointer overflow-hidden relative">
                                        <input type="file" accept="image/*" onChange={handleUpload} className="absolute inset-0 opacity-0 cursor-pointer z-20" />
                                        {originalSheet ? (
                                            <div className="w-full h-full p-2 flex flex-col items-center justify-center relative z-10"><img src={originalSheet.src} className="max-w-full max-h-full object-contain shadow-sm rounded-lg" alt="Preview" /></div>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center z-10 pointer-events-none">
                                                <div className="w-16 h-16 bg-slate-800 text-line rounded-2xl flex items-center justify-center mb-4 shadow-sm group-hover:scale-110 group-hover:bg-white transition-all border border-slate-700">
                                                    <IconUpload className="w-8 h-8" />
                                                </div>
                                                <span className="bg-white text-slate-900 px-6 py-2 rounded-full font-bold shadow-md group-hover:shadow-lg transition-all">é¸æ“‡æª”æ¡ˆ</span>
                                                <span className="text-xs text-slate-500 mt-3">æˆ–æ˜¯å°‡åœ–ç‰‡æ‹–æ›³è‡³æ­¤</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {originalSheet && (
                                    <button onClick={performSlice} className="mt-8 bg-line hover:bg-green-600 text-white px-12 py-4 rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all btn-press flex items-center justify-center gap-3 mx-auto text-lg">
                                        {isProcessing ? <IconLoader /> : <IconScissors />} é–‹å§‹åˆ‡å‰²
                                    </button>
                                )}
                            </div>

                            <div className="lg:col-span-2 bg-slate-800/80 p-6 rounded-3xl border border-slate-700 h-fit space-y-6 text-slate-300">
                                <h3 className="text-xl font-bold text-white mb-4 border-b border-slate-600 pb-3">ã€Line è²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹ æ­¥é©Ÿèªªæ˜ã€‘</h3>
                                <div className="space-y-4">
                                    <div>
                                        <div className="font-bold text-line text-lg mb-1">Step 1ï¼šå…ˆæŠŠä½ çš„è²¼åœ–ã€Œç”Ÿã€å‡ºä¾†ï¼</div>
                                        <p className="text-sm leading-relaxed text-slate-400">é‚„æ²’æœ‰åœ–ç‰‡ï¼Ÿå®Œå…¨æ²’å•é¡Œï½<br />ç›´æ¥ä½¿ç”¨ä¸‹æ–¹ Meikoå¹«å¤§å®¶è¨­è¨ˆçš„ã€AI æç¤ºè©å¤§å¸«ã€‘ï¼ŒæŒ‘é¸é©åˆçš„promptå¾Œï¼Œç”Ÿæˆåœ–ç‰‡(Promptå…§æ©˜è‰²æ–‡å­—éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„)ã€‚åŠ é»ä½ çš„å‰µæ„èª¿å‘³ï¼Œç”¨ Gemini Nano Banana Pro / ChatGPT ...ç­‰AIå·¥å…· å°±èƒ½ç”Ÿæˆè¶…å¯æ„›è²¼åœ–ç´ æï¼</p>
                                    </div>
                                    <div>
                                        <div className="font-bold text-line text-lg mb-1">Step 2ï¼šç”¨ã€ŠLINEè²¼åœ–è‡ªå‹•åŒ–åŠ©æ‰‹ã€‹ä¸€éµæå®šåˆ‡åœ–ï¼‹å»èƒŒï¼</div>
                                        <p className="text-sm text-slate-400">ä¸‹è¼‰å‰è¨˜å¾—å…ˆåšå…©ä»¶å°äº‹ï¼š</p>
                                        <ul className="list-none pl-0 mt-1 space-y-2 text-xs text-slate-300">
                                            <li className="bg-slate-900 p-3 rounded-lg border border-slate-700"><span className="font-bold text-white">â‘  é¸æ“‡ main / tab å°é¢åœ–</span><br />æŒ‘ä¸€å¼µæœ€èƒ½ä»£è¡¨ä½ è§’è‰²éˆé­‚çš„å°é¢åœ–ï¼ŒæŒ‰ä¸€ä¸‹ã€ŒMain å’Œ tabæŒ‰éˆ•ï¼ˆå»ºè­°ä½¿ç”¨åŒä¸€å¼µè²¼åœ–ï¼‰ã€å°±è¨­å®šå®Œæˆï¼Œä¸‹è¼‰æ™‚å¯ä»¥ä¸€ä½µä¸‹è¼‰ä¸‹ä¾†ã€‚</li>
                                            <li className="bg-slate-900 p-3 rounded-lg border border-slate-700"><span className="font-bold text-white">â‘¡ è¨­å®šæª”åèµ·å§‹ç·¨è™Ÿ</span><br />å¦‚æœä½ æ­£åœ¨ç”Ÿç”¢ç¬¬äºŒçµ„è²¼åœ–ï¼ŒæŠŠèµ·å§‹ç·¨è™Ÿæ”¹æˆ 13ï¼Œé€™æ¨£ä¸‹è¼‰å¾Œå…¨éƒ¨ 40 å¼µè²¼åœ–ï¼ˆå« mainã€tabï¼‰æœƒä¹–ä¹–æ’å¥½éšŠï¼Œè¼•é¬†å½™æ•´é€²åŒä¸€å€‹å£“ç¸®æª”ï¼Œå®Œå…¨ä¸æœƒæ’è™Ÿ âœ¨</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <div className="font-bold text-line text-lg mb-1">Step 3ï¼šåˆ° LINE Creators Market ä¸€éµä¸Šå‚³ï¼</div>
                                        <p className="text-sm text-slate-400">æ‰“é–‹ <a href="https://creator.line.me/zh-hant/" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:text-blue-300 underline font-bold">Line Creators Market</a>ï¼Œæ•´åŒ…å£“ç¸®æª”ç›´æ¥ä¸Šå‚³ï½</p>
                                        <p className="text-xs text-slate-500 mt-2 pt-2 border-t border-slate-700">
                                            æé†’ï¼šå®Œæˆåˆ†å‰²å»èƒŒå¾Œçš„è²¼åœ–ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨å…¶ä»–ç¤¾ç¾¤å·¥å…·å…§ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼šIGã€Messengerã€WhatsAPPã€Telegramã€Discord.....ç­‰ç­‰ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-6 mb-8">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-bold text-lg text-white flex items-center gap-2"><IconWand2 className="w-5 h-5 text-line" /> AI æç¤ºè©å¤§å¸«</h3>
                                <button onClick={() => setShowPromptGuide(!showPromptGuide)} className="text-xs text-slate-400 hover:text-white flex items-center gap-1">
                                    {showPromptGuide ? "éš±è—" : "å±•é–‹"} <IconChevronDown className={`w-3 h-3 transition-transform ${showPromptGuide ? 'rotate-180' : ''}`} />
                                </button>
                            </div>
                            <div className={`transition-all duration-300 ${showPromptGuide ? 'opacity-100' : 'opacity-50 grayscale'}`}>
                                <div className="p-4 bg-slate-900 border border-slate-700 rounded-xl mb-4 space-y-4">
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold text-slate-400">1. é¸æ“‡ä¸»é¡Œå…§å®¹ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {Object.entries(PROMPT_THEMES).map(([key, theme]) => (
                                                <button key={key} onClick={() => setActiveTheme(key)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${activeTheme === key ? 'bg-blue-600 text-white border-blue-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>{theme.label}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <span className="text-xs font-bold text-slate-400">2. é¸æ“‡ç•«é¢¨ï¼š</span>
                                        <div className="flex gap-2 flex-wrap">
                                            {Object.entries(PROMPT_STYLES).map(([key, style]) => (
                                                <button key={key} onClick={() => setActiveStyle(key)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${activeStyle === key ? 'bg-purple-600 text-white border-purple-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:border-slate-500'}`}>{style.label}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <PromptDisplay />
                                <div className="mt-4 flex justify-end">
                                    <button onClick={handleCopyPrompt} className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all ${copySuccess ? 'bg-green-600 text-white' : 'bg-white text-slate-900 hover:bg-slate-200'}`}>
                                        {copySuccess ? <IconCheckCircle className="w-5 h-5" /> : <IconCopy className="w-5 h-5" />}
                                        {copySuccess ? "å·²è¤‡è£½æˆåŠŸï¼" : "è¤‡è£½ Prompt"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className={`step-card bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-8 mb-8 ${step !== 2 && 'hidden'}`}>
                        <div className="flex flex-col xl:flex-row justify-between items-start gap-8">
                            <div className={`transition-all duration-500 ${showSettings ? 'w-full xl:w-2/3' : 'w-full'}`}>
                                <div className={`grid gap-4 ${showSettings ? 'grid-cols-3 md:grid-cols-4 lg:grid-cols-4' : 'grid-cols-3 md:grid-cols-4 lg:grid-cols-6'}`}>
                                    {slicedPieces.map((p) => (
                                        <div key={p.id} className="aspect-square bg-slate-900 rounded-xl border border-slate-700 p-2 flex items-center justify-center">
                                            <img src={p.previewUrl} className="w-full h-full object-contain" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className={`transition-all duration-500 bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden ${showSettings ? 'w-full xl:w-1/3 opacity-100' : 'w-full xl:w-12 h-16 xl:h-auto opacity-80 cursor-pointer hover:bg-slate-800'}`}>
                                <div onClick={() => setShowSettings(!showSettings)} className="p-6 flex items-center justify-between cursor-pointer">
                                    <div className={`flex items-center gap-2 font-bold text-white whitespace-nowrap ${!showSettings && 'xl:hidden'}`}>
                                        <IconSettings className="w-5 h-5 text-line" /> å•Ÿç”¨æ™ºèƒ½å»èƒŒ
                                    </div>
                                    <div className={`hidden xl:flex flex-col items-center gap-4 py-4 ${showSettings && 'hidden'}`}>
                                        <IconSettings className="w-6 h-6 text-slate-400" />
                                        <span className="text-[10px] text-slate-500 writing-vertical-lr tracking-widest">é»æ“Šå±•é–‹è¨­å®š</span>
                                    </div>
                                    <div className={`relative inline-flex items-center cursor-pointer ${!showSettings && 'xl:hidden'}`}>
                                        <input type="checkbox" checked={autoRemoveBg} onChange={(e) => { e.stopPropagation(); setAutoRemoveBg(e.target.checked) }} className="sr-only peer" />
                                        <div className="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-line"></div>
                                    </div>
                                </div>
                                <div className={`px-6 pb-6 space-y-6 ${!showSettings && 'hidden'}`}>
                                    {autoRemoveBg && (
                                        <div className="space-y-6 animate-fade-in">
                                            <div>
                                                <div className="flex justify-between text-xs text-slate-400 mb-2 font-medium"><span>å¿«é€Ÿè¨­å®š (Presets)</span></div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={() => applyPreset('black')} className={`px-3 py-3 rounded-xl border text-xs font-bold flex flex-col items-center justify-center gap-2 transition ${targetColorHex === '#000000' ? 'bg-slate-800 text-white border-slate-600 shadow-md' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-slate-500'}`}><IconMoon className="w-4 h-4" /> <span>é»‘åº•å»èƒŒ</span></button>
                                                    <button onClick={() => applyPreset('green')} className={`px-3 py-3 rounded-xl border text-xs font-bold flex flex-col items-center justify-center gap-2 transition ${targetColorHex === '#00FF00' ? 'bg-green-900/30 text-green-400 border-green-700 shadow-sm' : 'bg-slate-900 text-slate-400 border-slate-700 hover:border-green-800'}`}><div className="w-4 h-4 bg-green-500 rounded-full"></div> <span>ç¶ å¹•å»èƒŒ</span></button>
                                                </div>
                                            </div>
                                            <button onClick={() => setShowAdvanced(!showAdvanced)} className="w-full flex items-center justify-between text-xs text-slate-400 hover:text-white pt-2 border-t border-slate-700">
                                                <span className="flex items-center gap-1"><IconSettings className="w-3 h-3" /> é¡¯ç¤ºé€²éšè¨­å®š</span>
                                                <IconChevronDown className={`w-3 h-3 transition-transform ${showAdvanced ? 'rotate-180' : ''}`} />
                                            </button>
                                            <div className={`collapse-content ${showAdvanced ? 'collapse-open' : ''}`}>
                                                <div className="pt-4 space-y-4">
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1">
                                                            <span className="flex items-center gap-1"><IconCrop className="w-3 h-3" /> è£åˆ‡ç¸®æ”¾ (å»é™¤é»‘é‚Š)</span>
                                                            <span className="font-bold text-line">{Math.round((zoomLevel - 1) * 100)}%</span>
                                                        </div>
                                                        <input type="range" min="1.00" max="1.50" step="0.01" value={zoomLevel} onChange={(e) => setZoomLevel(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                                        <div className="text-[10px] text-slate-500 mt-1">è‹¥å…©å´ä»æœ‰é»‘é‚Šï¼Œè«‹å°‡æ•¸å€¼å¾€å³æ‹‰å¤§</div>
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>ç›®æ¨™é¡è‰²</span><span className="font-mono">{targetColorHex}</span></div>
                                                        <input type="color" value={targetColorHex} onChange={(e) => setTargetColorHex(e.target.value)} className="w-full h-8 rounded cursor-pointer border border-slate-600 p-0" />
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>è‰²å½©å®¹è¨±åº¦ (Tolerance)</span><span>{colorTolerance}</span></div>
                                                        <input type="range" min="1" max="100" value={colorTolerance} onChange={(e) => setColorTolerance(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                    <div className="bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <div className="flex justify-between text-[10px] text-slate-400 mb-1"><span>é‚Šç·£æŸ”åŒ– (Smoothness)</span><span>{smoothness}</span></div>
                                                        <input type="range" min="0" max="10" step="1" value={smoothness} onChange={(e) => setSmoothness(Number(e.target.value))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                    <div className="flex items-center justify-between bg-slate-800 p-3 rounded-lg border border-slate-600 shadow-sm">
                                                        <span className="text-[10px] text-slate-400">æº¢è‰²å»é™¤ (Despill)</span>
                                                        <input type="checkbox" checked={despill} onChange={(e) => setDespill(e.target.checked)} className="accent-green-500 w-4 h-4" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-center gap-4 pt-8 border-t border-slate-700 mt-6">
                            <button onClick={() => setStep(1)} className="px-6 py-3 rounded-xl font-bold text-slate-400 bg-slate-900 hover:bg-slate-700 hover:text-white transition">é‡æ–°ä¸Šå‚³</button>
                            <button onClick={performProcessing} disabled={isProcessing} className="bg-line hover:bg-green-600 text-white px-12 py-3 rounded-xl font-bold shadow-lg shadow-green-900 transition-all btn-press flex items-center justify-center gap-2 min-w-[240px]">
                                {isProcessing ? <><IconLoader /><span>è™•ç†ä¸­ ({processedCount}/12)</span></> : <><IconEraser />åŸ·è¡Œå»èƒŒ</>}
                            </button>
                        </div>
                    </div>

                    <div className={`step-card bg-slate-800 rounded-3xl shadow-lg border border-slate-700 p-8 mb-8 ${step !== 3 && 'hidden'}`}>
                        <div className="mb-8 border-b border-slate-700 pb-6">
                            <h2 className="text-2xl font-bold text-white flex items-center gap-2 mb-2"><IconCheckCircle className="text-line" />è¨­å®šèˆ‡æ‰“åŒ…</h2>
                            <p className="text-slate-400 text-sm">è«‹å‹¾é¸ä¸»åœ–(Main)èˆ‡æ¨™ç±¤åœ–(Tab) <span className="text-xs text-slate-500">(å¯é¸)</span>ã€‚</p>
                        </div>

                        <div className="flex flex-col xl:flex-row gap-6 items-end mb-8">
                            <div className="w-full xl:flex-1 bg-yellow-500/10 border border-yellow-500/30 p-5 rounded-xl text-lg text-yellow-200">
                                <div className="font-bold flex items-center gap-2 mb-3 text-yellow-400 text-xl"><IconInfo className="w-6 h-6" /> ä¸‹è¼‰å‰è¨˜å¾—å…ˆåšå…©ä»¶å°äº‹ï¼š</div>
                                <ul className="list-disc pl-6 space-y-3 opacity-90 text-base md:text-lg">
                                    <li>é¸æ“‡ <span className="text-white font-bold bg-yellow-600/30 px-1 rounded">main / tab å°é¢åœ–</span>ï¼šæŒ‘ä¸€å¼µæœ€èƒ½ä»£è¡¨ä½ è§’è‰²éˆé­‚çš„å°é¢åœ–ï¼ŒæŒ‰ä¸€ä¸‹å°±è¨­å®šå®Œæˆï¼</li>
                                    <li>è¨­å®š <span className="text-white font-bold bg-yellow-600/30 px-1 rounded">æª”åèµ·å§‹ç·¨è™Ÿ</span>ï¼šç¬¬äºŒçµ„è²¼åœ–è«‹æ”¹ç‚º 13ï¼Œä¸‹è¼‰å¾Œ 40 å¼µè²¼åœ–è‡ªå‹•æ’éšŠï¼Œå®Œå…¨ä¸æ’è™Ÿ âœ¨</li>
                                </ul>
                            </div>

                            <div className="w-full xl:w-auto flex flex-row items-stretch gap-3">
                                <div className="bg-slate-900 px-4 py-2 rounded-xl border border-slate-600 flex flex-col justify-center min-w-[140px]">
                                    <span className="text-xs font-bold text-slate-400 flex items-center gap-1 mb-1"><IconHash className="w-3 h-3" /> èµ·å§‹ç·¨è™Ÿ</span>
                                    <input type="number" min="1" value={startNumber} onChange={(e) => setStartNumber(Math.max(1, parseInt(e.target.value) || 1))} className="w-full bg-slate-800 border border-slate-600 text-white rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-green-500 outline-none py-1" />
                                </div>
                                <button onClick={downloadZip} className="flex-1 bg-line hover:bg-green-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg transition-all btn-press flex items-center justify-center gap-2 text-lg whitespace-nowrap"><IconDownload className="w-6 h-6" /> ä¸‹è¼‰å®Œæ•´ ZIP</button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                            {finalImages.map((img, idx) => (
                                <div key={img.id} className="bg-slate-900 rounded-2xl border border-slate-700 p-3 hover:border-green-500 hover:shadow-md transition-all">
                                    <div className="aspect-[370/320] grid-bg rounded-xl flex items-center justify-center overflow-hidden border border-slate-700 mb-3"><img src={img.dataUrl} className="w-full h-full object-contain" /></div>
                                    <div className="text-center text-sm font-bold text-slate-400 mb-4 bg-slate-800 rounded py-1">{getFileName(idx)}.png</div>
                                    <div className="space-y-2">
                                        <label className="flex items-center gap-2 cursor-pointer group">
                                            <input type="radio" name="main_select" checked={mainId === img.id} onChange={() => setMainId(img.id)} className="hidden custom-radio" />
                                            <div className={`flex-1 text-xs border rounded-lg px-2 py-2 flex items-center gap-1 justify-center transition-all ${mainId === img.id ? 'bg-green-900/40 border-line text-line font-bold' : 'bg-slate-800 border-slate-600 text-slate-500 group-hover:bg-slate-700 group-hover:border-slate-500'}`}><IconStar className="w-3 h-3" /> Main</div>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer group">
                                            <input type="radio" name="tab_select" checked={tabId === img.id} onChange={() => setTabId(img.id)} className="hidden custom-radio" />
                                            <div className={`flex-1 text-xs border rounded-lg px-2 py-2 flex items-center gap-1 justify-center transition-all ${tabId === img.id ? 'bg-green-900/40 border-line text-line font-bold' : 'bg-slate-800 border-slate-600 text-slate-500 group-hover:bg-slate-700 group-hover:border-slate-500'}`}><IconTag className="w-3 h-3" /> Tab</div>
                                        </label>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="text-center mt-10"><button onClick={() => setStep(1)} className="text-slate-500 hover:text-slate-300 text-sm font-medium transition-colors underline">è™•ç†ä¸‹ä¸€å¼µåŸå§‹åœ–</button></div>
                    </div>


                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>